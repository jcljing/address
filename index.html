<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é™¤ç”²é†›æ–½å·¥åŠ©æ‰‹ - åœ°å€æœç´¢</title>
    <style>
        /* çœç•¥æ ·å¼ä»£ç ï¼Œä¿æŒä¸å˜ */
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">ğŸ </div>
            <h2>å°åŒºåœ°å€æœç´¢</h2>
        </div>
        <div class="search-card">
            <input type="search" id="searchInput" placeholder="è¯·è¾“å…¥å°åŒºåç§°">
            <div class="city-row">
                <select id="citySelect">
                    <option value="åŒ—äº¬">åŒ—äº¬å¸‚</option>
                    <option value="ä¸Šæµ·">ä¸Šæµ·å¸‚</option>
                    <option value="å¹¿å·">å¹¿å·å¸‚</option>
                    <option value="æ·±åœ³">æ·±åœ³å¸‚</option>
                </select>
                <button id="searchBtn">æœç´¢</button>
            </div>
        </div>
        <div id="resultsCard" class="results-card">
            <div id="resultsList"></div>
        </div>
    </div>
    <div id="actionBar" class="action-bar">
        <button class="action-btn nav-btn" onclick="openNav()">ğŸ—ºï¸ å¯¼èˆª</button>
        <button class="action-btn copy-btn" onclick="copyAddr()">ğŸ“‹ å¤åˆ¶åœ°å€</button>
    </div>
    <script>
        const TENCENT_MAP_KEY = "LYQBZ-INAC4-MJ3UL-FVAGL-GYXH2-BYFSU";
        let searchResults = [];
        let selectedItem = null;

        document.getElementById('searchBtn').onclick = () => {
            const query = document.getElementById('searchInput').value.trim();
            if (query) performSearch(query);
        };

        // JSONP æœç´¢é€»è¾‘
        function performSearch(query) {
            const city = document.getElementById('citySelect').value;
            const callbackName = 'jsonp_callback_' + Math.round(Math.random() * 1000000);

            // 1. å®šä¹‰å›è°ƒ
            window[callbackName] = function(data) {
                delete window[callbackName];
                document.body.removeChild(document.getElementById(callbackName));
                if (data.status === 0 && data.data) {
                    searchResults = data.data;
                    renderList(data.data);
                } else {
                    alert("æœç´¢å¤±è´¥: " + data.message);
                }
            };

            // 2. æ„é€  URL (å¿…é¡»å¸¦ output=jsonp)
            const url = `https://apis.map.qq.com/ws/place/v1/suggestion/?keyword=${encodeURIComponent(query)}&region=${encodeURIComponent(city)}&key=${TENCENT_MAP_KEY}&output=jsonp&callback=${callbackName}`;

            // 3. æ’å…¥ Script æ ‡ç­¾
            const script = document.createElement('script');
            script.id = callbackName;
            script.src = url;
            document.body.appendChild(script);
        }

        function renderList(items) {
            const card = document.getElementById('resultsCard');
            const list = document.getElementById('resultsList');
            card.style.display = 'block';
            list.innerHTML = items.map((item, i) => `
                <div class="result-item" onclick="selectItem(${i})">
                    <div class="result-title">${item.title}</div>
                    <div class="result-address">${item.address}</div>
                </div>
            `).join('');
        }

        function selectItem(i) {
            selectedItem = searchResults[i];
            document.getElementById('actionBar').style.display = 'flex';
            document.querySelectorAll('.result-item').forEach((el, idx) => {
                el.style.background = idx === i ? '#f0f7ff' : '#fff';
            });
        }

        function copyAddr() {
            const text = `${selectedItem.title} (${selectedItem.address})`;
            navigator.clipboard.writeText(text).then(() => alert("å·²å¤åˆ¶"));
        }

        function openNav() {
            const { lat, lng } = selectedItem.location;
            window.location.href = `https://apis.map.qq.com/uri/v1/routeplan?type=drive&to=${encodeURIComponent(selectedItem.title)}&tocoord=${lat},${lng}&referer=myapp`;
        }
    </script>
</body>
</html>
