<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°åŒºåœ°å€æœç´¢ - é™¤ç”²é†›æ–½å·¥åŠ©æ‰‹</title>
    <style>
        /* çœç•¥æ ·å¼ä»£ç ï¼Œä¿æŒä¸å˜ */
    </style>
</head>
<body>
    <div class="container">
        <!-- çœç•¥å¤´éƒ¨å’Œæœç´¢æ¡†ä»£ç ï¼Œä¿æŒä¸å˜ -->
        
        <div class="search-card">
            <div class="search-box">
                <div class="search-icon">ğŸ”</div>
                <input type="text" id="searchInput" placeholder="è¾“å…¥å°åŒºåç§°ï¼Œå¦‚ï¼šä¸‡ç§‘åŸå¸‚èŠ±å›­" autocomplete="off">
            </div>
            
            <div class="city-row">
                <span class="city-label">åŸå¸‚ï¼š</span>
                <select id="citySelect">
                    <option value="åŒ—äº¬">åŒ—äº¬å¸‚</option>
                    <option value="ä¸Šæµ·">ä¸Šæµ·å¸‚</option>
                    <option value="å¹¿å·">å¹¿å·å¸‚</option>
                    <option value="æ·±åœ³">æ·±åœ³å¸‚</option>
                    <option value="æˆéƒ½">æˆéƒ½å¸‚</option>
                    <option value="æ­å·">æ­å·å¸‚</option>
                    <option value="æ­¦æ±‰">æ­¦æ±‰å¸‚</option>
                    <option value="å—äº¬">å—äº¬å¸‚</option>
                </select>
                <button id="searchBtn">æœç´¢</button>
            </div>
        </div>
        
        <div class="results-card" id="resultsCard">
            <div class="loading" id="loading" style="display: none;">
                <span class="loading-spinner"></span> æ­£åœ¨æœç´¢ä¸­...
            </div>
            <div id="resultsList"></div>
        </div>
        
        <div class="action-bar" id="actionBar">
            <button class="action-btn copy-btn" onclick="copyAddress()">ğŸ“‹ å¤åˆ¶åœ°å€</button>
            <button class="action-btn nav-btn" onclick="openNavigation()">ğŸ—ºï¸ å¼€å§‹å¯¼èˆª</button>
        </div>
    </div>
    
    <div class="toast" id="toast">å·²å¤åˆ¶åˆ°å‰ªè´´æ¿</div>

    <script>
        // é…ç½®æ‚¨çš„è…¾è®¯åœ°å›¾API Key
        const TENCENT_MAP_KEY = "LYQBZ-INAC4-MJ3UL-FVAGL-GYXH2-BYFSU";
        
        // éªŒè¯Keyæ ¼å¼
        if (!TENCENT_MAP_KEY || TENCENT_MAP_KEY.includes("YOUR")) {
            alert("è¯·é…ç½®æ­£ç¡®çš„è…¾è®¯åœ°å›¾API Key");
        }
        
        let currentCity = "åŒ—äº¬";
        let selectedResult = null;
        let searchResults = [];
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // ç»‘å®šäº‹ä»¶
            const searchInput = document.getElementById('searchInput');
            const searchBtn = document.getElementById('searchBtn');
            const citySelect = document.getElementById('citySelect');
            
            // å®æ—¶æœç´¢
            searchInput.addEventListener('input', function(e) {
                const query = e.target.value.trim();
                if (query.length > 0) {
                    debounceSearch(query);
                } else {
                    hideResults();
                }
            });
            
            // å›è½¦æœç´¢
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const query = e.target.value.trim();
                    if (query) performSearch(query);
                }
            });
            
            // ç‚¹å‡»æœç´¢
            searchBtn.addEventListener('click', function() {
                const query = searchInput.value.trim();
                if (query) performSearch(query);
            });
            
            // åŸå¸‚åˆ‡æ¢
            citySelect.addEventListener('change', function(e) {
                currentCity = e.target.value;
                const query = searchInput.value.trim();
                if (query) performSearch(query);
            });
            
            // åˆå§‹ç„¦ç‚¹
            setTimeout(() => searchInput.focus(), 300);
            
            // æ˜¾ç¤ºå†å²è®°å½•
            loadHistory();
        });
        
        // é˜²æŠ–æœç´¢
        let debounceTimer;
        function debounceSearch(query) {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                if (query.trim().length > 0) {
                    performSearch(query);
                }
            }, 300);
        }
        
        // æ‰§è¡Œæœç´¢
        async function performSearch(query) {
            if (!query.trim()) return;
            
            // æ˜¾ç¤ºåŠ è½½
            document.getElementById('loading').style.display = 'block';
            document.getElementById('resultsCard').style.display = 'block';
            document.getElementById('actionBar').style.display = 'none';
            document.getElementById('resultsList').innerHTML = '';
            
            try {
                const results = await searchTencentMap(query, currentCity);
                searchResults = results;
                displayResults(results);
                
                // ä¿å­˜åˆ°å†å²è®°å½•
                saveToHistory(query, currentCity);
            } catch (error) {
                console.error('æœç´¢é”™è¯¯:', error);
                document.getElementById('resultsList').innerHTML = `
                    <div class="empty-state">
                        <p>æœç´¢å¤±è´¥</p>
                        <small>${error.message || 'è¯·æ£€æŸ¥ç½‘ç»œæˆ–Keyé…ç½®'}</small>
                    </div>
                `;
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }
        
        // è…¾è®¯åœ°å›¾æœç´¢
        async function searchTencentMap(query, city) {
            const encodedQuery = encodeURIComponent(query);
            const encodedCity = encodeURIComponent(city);
            
            // ä¿®æ­£åçš„URLï¼Œç§»é™¤å¤šä½™çš„æ–œæ 
            const url = `https://apis.map.qq.com/ws/place/v1/suggestion/?keyword=${encodedQuery}&region=${encodedCity}&key=${TENCENT_MAP_KEY}&output=json`;
            
            console.log('æœç´¢URL:', url);
            
            const response = await fetch(url, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP é”™è¯¯! çŠ¶æ€: ${response.status}`);
            }
            
            const data = await response.json();
            
            console.log('APIå“åº”:', data);
            
            if (data.status === 0 && data.data && Array.isArray(data.data)) {
                return data.data.map(item => ({
                    id: item.id,
                    title: item.title,
                    address: item.address || '',
                    province: item.province || '',
                    city: item.city || '',
                    district: item.district || '',
                    lat: item.location && item.location.lat,
                    lng: item.location && item.location.lng,
                    category: item.category || '',
                    adcode: item.adcode || ''
                }));
            } else if (data.status === 373) {
                throw new Error('API Keyé…ç½®é”™è¯¯ï¼Œè¯·æ£€æŸ¥åŸŸåç™½åå•');
            } else if (data.status === 300) {
                throw new Error('è¯·æ±‚å‚æ•°é”™è¯¯');
            } else {
                throw new Error(data.message || 'æœç´¢å¤±è´¥');
            }
        }
        
        // æ˜¾ç¤ºç»“æœ
        function displayResults(results) {
            const resultsList = document.getElementById('resultsList');
            
            if (!results || results.length === 0) {
                resultsList.innerHTML = `
                    <div class="empty-state">
                        <p>æ²¡æœ‰æ‰¾åˆ°ç›¸å…³åœ°å€</p>
                        <small>è¯·å°è¯•å…¶ä»–å…³é”®è¯</small>
                    </div>
                `;
                return;
            }
            
            let html = '';
            results.forEach((item, index) => {
                const address = item.address || `${item.district}${item.city ? item.city : currentCity}`;
                html += `
                    <div class="result-item" onclick="selectResult(${index})" data-index="${index}">
                        <div class="result-title">${item.title}</div>
                        <div class="result-address">${address}</div>
                        <div class="result-district">${item.district} Â· ${item.category || 'åœ°ç‚¹'}</div>
                    </div>
                `;
            });
            
            resultsList.innerHTML = html;
        }
        
        // é€‰æ‹©ç»“æœ
        function selectResult(index) {
            selectedResult = searchResults[index];
            if (!selectedResult) return;
            
            // é«˜äº®é€‰ä¸­
            document.querySelectorAll('.result-item').forEach(item => {
                item.style.background = '';
            });
            event.currentTarget.style.background = '#f0f7ff';
            
            // æ˜¾ç¤ºæ“ä½œæ 
            document.getElementById('actionBar').style.display = 'flex';
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            setTimeout(() => {
                document.getElementById('actionBar').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);
        }
        
        // å¤åˆ¶åœ°å€
        function copyAddress() {
            if (!selectedResult) return;
            
            const addressStr = `${selectedResult.title}ï¼ˆ${selectedResult.address}ï¼‰`;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(addressStr).then(() => {
                    showToast('åœ°å€å·²å¤åˆ¶');
                }).catch(() => {
                    fallbackCopy(addressStr);
                });
            } else {
                fallbackCopy(addressStr);
            }
        }
        
        // å¤‡ç”¨å¤åˆ¶
        function fallbackCopy(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            
            try {
                document.execCommand('copy');
                showToast('åœ°å€å·²å¤åˆ¶');
            } catch (err) {
                showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
            }
            
            document.body.removeChild(textArea);
        }
        
        // æ‰“å¼€å¯¼èˆª
        function openNavigation() {
            if (!selectedResult || !selectedResult.lat || !selectedResult.lng) {
                alert('è¯¥åœ°å€ç¼ºå°‘åæ ‡ä¿¡æ¯');
                return;
            }
            
            const { lat, lng, title } = selectedResult;
            
            // è…¾è®¯åœ°å›¾å¯¼èˆªURL
            const tencentMapUrl = `https://apis.map.qq.com/uri/v1/routeplan?type=drive&to=${encodeURIComponent(title)}&tocoord=${lat},${lng}&referer=myapp`;
            
            // é«˜å¾·åœ°å›¾å¤‡ç”¨
            const gaodeMapUrl = `https://uri.amap.com/navigation?to=${lng},${lat},${encodeURIComponent(title)}&mode=car`;
            
            // åœ¨å¾®ä¿¡å†…ä¼˜å…ˆä½¿ç”¨è…¾è®¯åœ°å›¾
            if (navigator.userAgent.includes('MicroMessenger')) {
                window.location.href = tencentMapUrl;
            } else {
                // è¯¢é—®ç”¨æˆ·é€‰æ‹©
                if (confirm(`å¯¼èˆªåˆ°ï¼š${title}\n\nä½¿ç”¨è…¾è®¯åœ°å›¾å¯¼èˆªï¼Ÿ(ç¡®å®š)\nä½¿ç”¨é«˜å¾·åœ°å›¾å¯¼èˆªï¼Ÿ(å–æ¶ˆ)`)) {
                    window.location.href = tencentMapUrl;
                } else {
                    window.location.href = gaodeMapUrl;
                }
            }
        }
        
        // å†å²è®°å½•åŠŸèƒ½
        function saveToHistory(query, city) {
            let history = JSON.parse(localStorage.getItem('addressSearchHistory') || '[]');
            
            // å»é‡
            history = history.filter(item => !(item.query === query && item.city === city));
            
            // æ·»åŠ åˆ°å¼€å¤´
            history.unshift({
                query,
                city,
                timestamp: Date.now()
            });
            
            // ä¿ç•™æœ€è¿‘10æ¡
            history = history.slice(0, 10);
            
            localStorage.setItem('addressSearchHistory', JSON.stringify(history));
        }
        
        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('addressSearchHistory') || '[]');
            if (history.length > 0) {
                const historyHtml = history.map(item => 
                    `<div class="history-tag" onclick="searchHistory('${item.query}', '${item.city}')">${item.query}</div>`
                ).join('');
                
                // å¯ä»¥åœ¨è¿™é‡Œæ˜¾ç¤ºå†å²è®°å½•
            }
        }
        
        function searchHistory(query, city) {
            document.getElementById('searchInput').value = query;
            document.getElementById('citySelect').value = city;
            currentCity = city;
            performSearch(query);
        }
        
        // å·¥å…·å‡½æ•°
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }
        
        function hideResults() {
            document.getElementById('resultsCard').style.display = 'none';
            document.getElementById('actionBar').style.display = 'none';
        }
    </script>
</body>
</html>
